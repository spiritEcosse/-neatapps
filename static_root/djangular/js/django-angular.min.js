(function(angular,undefined){"use strict";var djng_forms_module=angular.module("ng.django.forms",[]);function hashCode(s){return s.split("").reduce(function(a,b){a=(a<<5)-a+b.charCodeAt(0);return a&a},0)}var form_elements=["input","select","textarea","datalist"];angular.forEach(form_elements,function(element){djng_forms_module.directive(element,addNgModelDirective())});function addNgModelDirective(){return["$compile",function($compile){return{restrict:"E",require:"?^form",link:function(scope,element,attr,formCtrl){var modelName;if(!formCtrl||angular.isUndefined(formCtrl.$name)||element.prop("type")==="hidden"||angular.isUndefined(attr.name)||angular.isDefined(attr.ngModel))return;modelName="dmy"+Math.abs(hashCode(formCtrl.$name))+"."+attr.name;attr.$set("ngModel",modelName);$compile(element,null,9999)(scope)}}}]}djng_forms_module.directive("djngError",function(){return{restrict:"A",require:"?^form",link:function(scope,element,attrs,formCtrl){var boundField;if(!formCtrl||angular.isUndefined(attrs.name)||attrs.djngError!=="bound-field")return;boundField=formCtrl[attrs.name];boundField.$setValidity("bound",false);boundField.$parsers.push(function(value){boundField.$setValidity("bound",true);element.removeAttr("djng-error")})}}});djng_forms_module.directive("ngModel",function(){function restoreInputField(modelCtrl,field){switch(field.type){case"radio":if(field.defaultChecked){modelCtrl.$setViewValue(field.defaultValue)}break;case"checkbox":if(field.defaultChecked){modelCtrl.$setViewValue(true)}break;case"password":modelCtrl.$setViewValue(null);break;default:if(field.defaultValue){modelCtrl.$setViewValue(field.defaultValue)}break}}function restoreSelectOptions(modelCtrl,field){var multivalues=[];angular.forEach(field.options,function(option){if(option.defaultSelected){angular.element(option).prop("selected","selected");if(field.multiple){multivalues.push(option.value)}else{modelCtrl.$setViewValue(option.value)}}});if(field.multiple){modelCtrl.$setViewValue(multivalues)}}function restoreTextArea(modelCtrl,field){if(field.defaultValue){modelCtrl.$setViewValue(field.defaultValue)}}return{restrict:"A",priority:1,require:["ngModel","^?form"],link:function(scope,element,attrs,ctrls){var field=angular.isElement(element)?element[0]:null;var modelCtrl=ctrls[0],formCtrl=ctrls[1]||null;if(!field||!formCtrl)return;switch(field.tagName){case"INPUT":restoreInputField(modelCtrl,field);break;case"SELECT":restoreSelectOptions(modelCtrl,field);break;case"TEXTAREA":restoreTextArea(modelCtrl,field);break;default:console.log("Unknown field type");break}formCtrl.$setPristine()}}});djng_forms_module.directive("validateMultipleFields",function(){return{restrict:"A",require:"^?form",link:function(scope,element,attrs,formCtrl){var subFields,checkboxElems=[];function validate(event){var valid=false;angular.forEach(checkboxElems,function(checkbox){valid=valid||checkbox.checked});formCtrl.$setValidity("required",valid);if(event){formCtrl.$dirty=true;formCtrl.$pristine=false;scope.$apply()}}if(!formCtrl)return;try{subFields=angular.fromJson(attrs.validateMultipleFields)}catch(SyntaxError){if(!angular.isString(attrs.validateMultipleFields))return;subFields=[attrs.validateMultipleFields];formCtrl=formCtrl[subFields]}angular.forEach(element.find("input"),function(elem){if(subFields.indexOf(elem.name)>=0){checkboxElems.push(elem);angular.element(elem).on("change",validate)}});element.on("$destroy",function(){angular.forEach(element.find("input"),function(elem){angular.element(elem).off("change")})});validate()}}});djng_forms_module.directive("validateDate",function(){var validDatePattern=null;function validateDate(date){var matched,dateobj;if(!date)return true;dateobj=new Date(date);if(isNaN(dateobj))return false;if(validDatePattern){matched=validDatePattern.exec(date);return matched&&parseInt(matched[2])===dateobj.getMonth()+1}return true}return{require:"?ngModel",restrict:"A",link:function(scope,elem,attrs,controller){if(!controller)return;if(attrs.validateDate){validDatePattern=new RegExp(attrs.validateDate,"i")}var validator=function(value){var validity=controller.$isEmpty(value)||validateDate(value);controller.$setValidity("date",validity);return validity?value:undefined};controller.$parsers.push(validator)}}});djng_forms_module.factory("djangoForm",function(){var NON_FIELD_ERRORS="__all__";function isNotEmpty(obj){for(var p in obj){if(obj.hasOwnProperty(p))return true}return false}function resetFieldValidity(field){var pos=field.$viewChangeListeners.push(field.clearRejected=function(){field.$message="";field.$setValidity("rejected",true);field.$viewChangeListeners.splice(pos-1,1);delete field.clearRejected})}function isField(field){return angular.isArray(field.$viewChangeListeners)}return{setErrors:function(form,errors){form.$message="";if(form.$error.hasOwnProperty("rejected")&&angular.isArray(form.$error.rejected)){var rejected=form.$error.rejected.concat();angular.forEach(rejected,function(rejected){var field,key=rejected.$name;if(form.hasOwnProperty(key)){field=form[key];if(isField(field)&&field.clearRejected){field.clearRejected()}else{field.$message="";angular.forEach(field,function(subField,subKey){if(subField&&isField(subField)&&subField.clearRejected){subField.clearRejected()}})}}})}angular.forEach(errors,function(errors,key){var field;if(errors.length>0){if(key===NON_FIELD_ERRORS){form.$message=errors[0];form.$setPristine()}else if(form.hasOwnProperty(key)){field=form[key];field.$message=errors[0];field.$setValidity("rejected",false);field.$setPristine();if(isField(field)){resetFieldValidity(field)}else{angular.forEach(field,function(subField,subKey){if(subField&&isField(subField)){resetFieldValidity(subField)}})}}}});return isNotEmpty(errors)}}});djng_forms_module.directive("djngBindIf",function(){return{restrict:"A",compile:function(templateElement){templateElement.addClass("ng-binding");return function(scope,element,attr){element.data("$binding",attr.ngBind);scope.$watch(attr.djngBindIf,function ngBindWatchAction(value){if(value===undefined)return;element.text(value)})}}}})})(window.angular);(function(angular,undefined){"use strict";var djng_rmi_module=angular.module("ng.django.rmi",[]);djng_rmi_module.provider("djangoRMI",function(){var remote_methods,http;this.configure=function(conf){remote_methods=conf;convert_configuration(remote_methods)};function convert_configuration(obj){angular.forEach(obj,function(val,key){if(!angular.isObject(val))throw new Error("djangoRMI.configure got invalid data");if(val.hasOwnProperty("url")){val.headers["X-Requested-With"]="XMLHttpRequest";obj[key]=function(data){var config=angular.copy(val);if(config.method==="POST"){if(data===undefined)throw new Error("Calling remote method "+key+" without data object");config.data=data}else if(config.method==="auto"){if(data===undefined){config.method="GET"}else{config.method="POST";config.data=data}}return http(config)}}else{convert_configuration(val)}})}this.$get=["$http",function($http){http=$http;return remote_methods}]})})(window.angular);(function(angular,undefined){"use strict";var djngUrls=angular.module("ng.django.urls",[]);djngUrls.provider("djangoUrl",function djangoUrlProvider(){var reverseUrl="/angular/reverse/";this.setReverseUrl=function(url){reverseUrl=url};this.$get=function(){return new djangoUrl(reverseUrl)}});var djangoUrl=function(reverseUrl){function forEachSorted(obj,iterator,context){var keys=sortedKeys(obj);for(var i=0;i<keys.length;i++){iterator.call(context,obj[keys[i]],keys[i])}return keys}function sortedKeys(obj){var keys=[];for(var key in obj){if(obj.hasOwnProperty(key)){keys.push(key)}}return keys.sort()}function buildUrl(url,params){if(!params)return url;var parts=[];forEachSorted(params,function(value,key){if(value===null||value===undefined)return;if(angular.isObject(value)){value=angular.toJson(value)}parts.push(encodeURIComponent(key)+"="+encodeURIComponent(value))});return url+(url.indexOf("?")===-1?"?":"&")+parts.join("&")}this.reverse=function(url_name,args_or_kwargs){var url=buildUrl(reverseUrl,{djng_url_name:url_name});if(Array.isArray(args_or_kwargs)){forEachSorted(args_or_kwargs,function(value){url=buildUrl(url,{djng_url_args:value})});return url}var params={};forEachSorted(args_or_kwargs,function(value,key){params["djng_url_kwarg_"+key]=value});if(angular.equals(params,{})){return url}return buildUrl(url,params)}}})(window.angular);(function(angular,undefined){"use strict";function noop(){}var djng_ws_module=angular.module("ng.django.websocket",[]);djng_ws_module.service("$websocket",function(){var ws;this.connect=function(url){ws=new WebSocket(url);ws.onopen=this.onopen;ws.onmessage=this.onmessage;ws.onerror=this.onerror;ws.onclose=this.onclose};this.send=function(msg){ws.send(msg)};this.close=function(){ws.close()}});djng_ws_module.provider("djangoWebsocket",function(){var _console={log:noop,warn:noop,error:noop};var websocket_uri,heartbeat_msg=null;this.setURI=function(uri){websocket_uri=uri;return this};this.setHeartbeat=function(msg){heartbeat_msg=msg;return this};this.setLogLevel=function(logLevel){switch(logLevel){case"debug":_console=console;break;case"log":_console.log=console.log;case"warn":_console.warn=console.warn;case"error":_console.error=console.error;default:break}return this};this.$get=["$websocket","$q","$timeout","$interval",function($websocket,$q,$timeout,$interval){var ws_url,deferred,scope,collection;var is_subscriber=false,is_publisher=false,receiving=false;var wait_for_reconnect=0,heartbeat_promise=null,missed_heartbeats=0;function connect(){_console.log("Connecting to "+ws_url);deferred=$q.defer();$websocket.connect(ws_url)}$websocket.onopen=function(evt){_console.log("Connected");deferred.resolve();wait_for_reconnect=0;if(heartbeat_msg&&heartbeat_promise===null){missed_heartbeats=0;heartbeat_promise=$interval(sendHeartbeat,5e3)}};$websocket.onclose=function(evt){_console.log("Disconnected");deferred.reject();wait_for_reconnect=Math.min(wait_for_reconnect+1e3,1e4);$timeout(function(){$websocket.connect(ws_url)},wait_for_reconnect)};$websocket.onerror=function(evt){_console.error("Websocket connection is broken!");$websocket.close()};$websocket.onmessage=function(evt){var data;if(evt.data===heartbeat_msg){missed_heartbeats=0;return}try{data=angular.fromJson(evt.data)}catch(e){_console.warn("Data received by server is invalid JSON: "+evt.data);return}if(is_subscriber){receiving=true;scope.$apply(function(){angular.extend(scope[collection],data)});receiving=false}};function sendHeartbeat(){try{missed_heartbeats++;if(missed_heartbeats>3)throw new Error("Too many missed heartbeats.");$websocket.send(heartbeat_msg)}catch(e){$interval.cancel(heartbeat_promise);heartbeat_promise=null;_console.warn("Closing connection. Reason: "+e.message);$websocket.close()}}function listener(newValue,oldValue){if(!receiving&&!angular.equals(oldValue,newValue)){$websocket.send(angular.toJson(newValue))}}function setChannels(channels){angular.forEach(channels,function(channel){if(channel.substring(0,9)==="subscribe"){is_subscriber=true}else if(channel.substring(0,7)==="publish"){is_publisher=true}})}function watchCollection(){scope.$watchCollection(collection,listener)}function buildWebsocketURL(facility,channels){var parts=[websocket_uri,facility,"?"];parts.push(channels.join("&"));ws_url=parts.join("")}return{connect:function($scope,scope_obj,facility,channels){scope=$scope;setChannels(channels);collection=scope_obj;scope[collection]=scope[collection]||{};buildWebsocketURL(facility,channels);connect();if(is_publisher){deferred.promise.then(watchCollection)}return deferred.promise}}}]})})(window.angular);